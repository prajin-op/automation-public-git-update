pipeline {
  agent any
  
  environment {
    INTERNAL_REPO_URL = "https://github.com/your-username/internal-repo.git"
    EXTERNAL_REPO_URL = "https://github.com/your-username/external-repo.git"
    INTERNAL_REPO_CREDENTIAL_ID = "internal-repo-credentials"
    EXTERNAL_REPO_CREDENTIAL_ID = "external-repo-credentials"
    NEW_BRANCH_NAME = "copy-internal-repo-content-${env.BUILD_ID}-${currentBuild.startTimeInMillis}"
  }
  
  stages {
    stage('Clone Repos') {
      steps {
        // Clone internal repo with credentials
        withCredentials([usernamePassword(credentialsId: "${INTERNAL_REPO_CREDENTIAL_ID}", usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
          sh "git clone https://${USERNAME}:${PASSWORD}@${INTERNAL_REPO_URL}"
        }
        
        // Clone external repo with credentials
        withCredentials([usernamePassword(credentialsId: "${EXTERNAL_REPO_CREDENTIAL_ID}", usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
          sh "git clone https://${USERNAME}:${PASSWORD}@${EXTERNAL_REPO_URL}"
        }
      }
    }
    
    stage('Copy Files') {
      steps {
        // Copy internal repo content to external repo
        sh "rsync -avz --exclude='file1' --exclude='dir1/' internal-repo/ external-repo/"
      }
    }
    
    stage('Create and Push Changes to New Branch') {
      steps {
        // Create new branch in external repo with credentials
        withCredentials([usernamePassword(credentialsId: "${EXTERNAL_REPO_CREDENTIAL_ID}", usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
          dir("external-repo") {
            sh "git checkout -b ${NEW_BRANCH_NAME}"
            sh "git add ."
            sh "git commit -m 'Copy internal repo content'"
            sh "git push https://${USERNAME}:${PASSWORD}@${EXTERNAL_REPO_URL} ${NEW_BRANCH_NAME}"
          }
        }
      }
    }
  }
}
