pipeline {
    agent any

    stages {
        stage('Clone source repository') {
            steps {
                git branch: 'master',
                    credentialsId: '<credentials_id>',
                    url: '<source_repo_url>'
            }
        }

        stage('Remove ignored files') {
            steps {
                script {
                    // Read the .jenkinsignore file
                    def jenkinsignore = readFile('.jenkinsignore')

                    // Split the file into separate lines
                    def lines = jenkinsignore.split('\n')

                    // Remove each file or directory listed in .jenkinsignore
                    for (int i = 0; i < lines.size(); i++) {
                        def line = lines[i].trim()
                        if (!line.isEmpty()) {
                            sh "rm -rf $line"
                        }
                    }
                }
            }
        }

        stage('Create PR') {
            steps {
                script {
                    // Checkout a new branch for the changes
                    sh "git checkout -b exclude-ignored-files"

                    // Add the changes to the branch
                    sh "git add ."

                    // Commit the changes
                    sh "git commit -m 'Exclude ignored files'"

                    // Push the changes to the target repository
                    git push: [
                        branch: 'exclude-ignored-files',
                        credentialsId: '<credentials_id>',
                        url: '<target_repo_url>'
                    ]

                    // Create a pull request
                    def pullRequest = github.createPullRequest(
                        head: "exclude-ignored-files",
                        base: "master",
                        title: "Exclude ignored files",
                        body: "This pull request removes the files listed in .jenkinsignore."
                    )

                    // Wait for the pull request to be processed
                    while (pullRequest.getMergeable().toString() == "null") {
                        sleep 1
                    }
                }
            }
        }
    }
}
