pipeline {
    agent any

    environment {
        INTERNAL_REPO_CREDENTIALS = credentials("i572426-prajin")
        EXTERNAL_REPO_CREDENTIALS = credentials("externalp")
        REPO_NAME = "automation-public-git-update"
        PR_TITLE = "Automated Pull Request"
        PR_BODY = "This is an automated pull request from the internal repository"
        IGNORE_FILE = "../internal-repo/.jenkinsignore"
    }

    stages {
        stage("Checkout internal repository") {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/master']],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [],
                    submoduleCfg: [],
                    userRemoteConfigs: [[
                        credentialsId: INTERNAL_REPO_CREDENTIALS,
                        url: 'https://github.tools.sap/I572426/automation-internal-git.git'
                    ]]
                ])
            }
        }

        stage("Checkout external repository") {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/master']],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [],
                    submoduleCfg: [],
                    userRemoteConfigs: [[
                        credentialsId: EXTERNAL_REPO_CREDENTIALS,
                        url: "https://github.com/prajin-op/$REPO_NAME.git"
                    ]]
                ])
            }
        }

        stage("Create and push new branch") {
            steps {
                script {
                    def BRANCH_NAME = "update-${new Date().format("yyyyMMdd-HHmmss")}"
                    sh "git checkout -b $BRANCH_NAME"
                    sh "git --git-dir=../$REPO_NAME/.git push --exclude-from=$IGNORE_FILE -u origin $BRANCH_NAME"
                    }
            }
        }

        stage("Create pull request") {
            steps {
                sh """
                curl -u $EXTERNAL_REPO_CREDENTIALS:x-oauth-basic \\
                -H "Content-Type: application/json" \\
                -X POST \\
                -d "{\\"title\\": \\"$PR_TITLE\\", \\"head\\": \\"$BRANCH_NAME\\", \\"base\\": \\"master\\", \\"body\\": \\"$PR_BODY\\"}" \\
                https://api.github.com/repos/<OWNER>/$REPO_NAME/pulls
                """
            }
        }
    }
}
